<script>
  // --- Cart state (items: { id, nameJa, nameEn, qty, priceJpy }) ---
  const cart = [];
  const drawer = document.getElementById('drawer');
  const cartItemsEl = document.getElementById('cartItems');
  const subtotalEl = document.getElementById('subtotal');
  const cartCount = document.getElementById('cartCount');

  function openCart(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); renderCart(); }
  function closeCart(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
  document.getElementById('openCart').addEventListener('click', openCart);
  document.getElementById('closeCart').addEventListener('click', closeCart);
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeCart(); });

  // Add to cart
  document.querySelectorAll('.card .add').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const card = e.target.closest('.card');
      const id = card.dataset.id;
      const nameJa = card.dataset.nameJa;
      const nameEn = card.dataset.nameEn;
      const priceJpy = parseInt(card.dataset.pricejpy, 10);

      const existing = cart.find(i => i.id === id);
      if (existing) existing.qty += 1;
      else cart.push({ id, nameJa, nameEn, qty: 1, priceJpy });

      openCart();
      renderCart();
    });
  });

  // Render cart
  function renderCart(){
    cartItemsEl.innerHTML = '';
    let subtotal = 0;

    cart.forEach(item => {
      subtotal += item.priceJpy * item.qty;
      const row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `
        <div style="width:56px;height:56px;border-radius:10px;background:#1b1b1b;border:1px solid #222"></div>
        <div>
          <div style="font-weight:600">${currentLang === 'ja' ? item.nameJa : item.nameEn}</div>
          <div class="small">¥${item.priceJpy.toLocaleString()} × ${item.qty}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
          <div class="qty">
            <button class="qty-btn" data-action="dec" data-key="${item.id}">-</button>
            <span>${item.qty}</span>
            <button class="qty-btn" data-action="inc" data-key="${item.id}">+</button>
          </div>
          <button class="small remove-btn" data-action="remove" data-key="${item.id}"
            style="background:transparent;border:0;color:#bbb;cursor:pointer"
            data-ja="削除" data-en="Remove">削除</button>
        </div>`;
      cartItemsEl.appendChild(row);
    });

    subtotalEl.textContent = '¥' + subtotal.toLocaleString();
    const count = cart.reduce((a,b)=>a+b.qty,0);
    cartCount.hidden = count === 0;
    if (!cartCount.hidden) cartCount.textContent = count;

    setLanguage(currentLang); // refresh labels
  }

  // Qty / remove
  cartItemsEl.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const key = btn.dataset.key;
    const action = btn.dataset.action;
    const item = cart.find(i => i.id === key);
    if (!item) return;

    if (action === 'inc') item.qty += 1;
    if (action === 'dec') item.qty = Math.max(1, item.qty - 1);
    if (action === 'remove') cart.splice(cart.findIndex(i => i.id === key), 1);
    renderCart();
  });

  // ✅ Checkout: send only { id, quantity }
  document.getElementById('checkout').addEventListener('click', async () => {
    if (cart.length === 0) {
      alert(currentLang === 'ja' ? 'カートが空です。' : 'Cart is empty.');
      return;
    }

    const items = cart.map(i => ({ id: i.id, quantity: i.qty }));

    try {
      const res = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      });

      const data = await res.json();

      if (res.ok && data.url) {
        window.location = data.url;
      } else {
        console.error('Checkout error:', data);
        alert(currentLang === 'ja'
          ? `チェックアウトに失敗しました: ${data?.error || '不明なエラー'}`
          : `Checkout failed: ${data?.error || 'Unknown error'}`);
      }
    } catch (err) {
      console.error('Network error:', err);
      alert(currentLang === 'ja'
        ? 'ネットワークエラーです。もう一度お試しください。'
        : 'Network error. Please try again.');
    }
  });

  // --- Language toggle (single, correct copy) ---
  let currentLang = localStorage.getItem('lang') || 'ja';
  const toggleBtn = document.getElementById('langToggle');

  function setLanguage(lang){
    toggleBtn.textContent = lang === 'ja' ? 'English' : '日本語';
    document.querySelectorAll('[data-ja]').forEach(el => {
      const txt = el.getAttribute(`data-${lang}`);
      if (txt != null) el.textContent = txt;
    });
  }

  document.addEventListener('DOMContentLoaded', () => setLanguage(currentLang));
  toggleBtn.addEventListener('click', () => {
    currentLang = currentLang === 'ja' ? 'en' : 'ja';
    localStorage.setItem('lang', currentLang);
    setLanguage(currentLang);
    renderCart();
  });
</script>
